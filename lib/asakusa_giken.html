<!-- BLEIo in -->
<script type='text/x-red' data-template-name='BLEIo in'>
  <div class='form-row'>
    <label for='node-input-name'>
      <i class='fa fa-tag'></i>
      <span data-i18n='node-red:common.label.name'></span>
    </label>
    <input type='text' id='node-input-name' data-i18n='[placeholder]node-red:common.label.name'>
  </div>
  <div class="form-row node-input-bleio">
    <label for="node-input-bleio">
      <i class="fa fa-random"></i>
      <span data-i18n="asakusa_giken.label.bleio"></span></label>
    <input type="text" id="node-input-bleio">
  </div>
  <div class="form-row" id="node-useString">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-useString" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-useString" style="width: 70%;" data-i18n="asakusa_giken.label.useString"></label>
  </div>
</script>

<script type='text/javascript'>
  RED.nodes.registerType('BLEIo in',{
    category: 'input',
    defaults: {
      name: { name: '' },
      bleio: { type: 'BLEIo', required: true },
      useString: { value: false, required: false }
    },
    color: 'Pink',
    inputs: 0,
    outputs: 1,
    icon: "bridge-dash.png",
    label: function() {
      return this.name || 'BLEIo';
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<!-- BLEIo out -->
<script type='text/x-red' data-template-name='BLEIo out'>
  <div class='form-row'>
    <label for='node-input-name'>
      <i class='fa fa-tag'></i>
      <span data-i18n='node-red:common.label.name'></span>
    </label>
    <input type='text' id='node-input-name' data-i18n='[placeholder]node-red:common.label.name'>
  </div>
  <div class="form-row node-input-bleio">
    <label for="node-input-bleio">
      <i class="fa fa-random"></i>
      <span data-i18n="asakusa_giken.label.bleio"></span></label>
    <input type="text" id="node-input-bleio">
  </div>
  <div class="form-row" id="node-useString">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-useString" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-useString" style="width: 70%;" data-i18n="asakusa_giken.label.useString"></label>
  </div>
</script>

<script type='text/javascript'>
  RED.nodes.registerType('BLEIo out',{
    category: 'output',
    defaults: {
      name: { name: '' },
      bleio: { type: 'BLEIo', required: true },
      useString: { value: false, required: false }
    },
    color: 'Pink',
    inputs: 1,
    outputs: 0,
    icon: "bridge-dash.png",
    align: 'right',
    label: function() {
      return this.name || 'BLEIo';
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<!-- BLEIo -->
<script type='text/x-red' data-template-name='BLEIo'>
  <div class='form-row'>
    <label for='node-config-input-localName'>
      <i class='fa fa-tag'></i>
      <span data-i18n='asakusa_giken.label.localName'></span>
    </label>
    <select type='text' id='node-config-input-localName' style='width: 30%;'>
    </select>
  </div>
  <div class='form-row'>
    <label for='node-config-input-address'>
      <i class='fa fa-random'></i>
      <span data-i18n='asakusa_giken.label.address'></span>
    </label>
    <input type='text' id='node-config-input-address' data-i18n='[placeholder]asakusa_giken.placeholder.optionalAddress'>
  </div>
  <div class='form-row'>
    <label for='node-config-input-uuid'>
      <i class='fa fa-random'></i>
      <span data-i18n='asakusa_giken.label.uuid'></span>
    </label>
    <input type='text' id='node-config-input-uuid' data-i18n='[placeholder]asakusa_giken.placeholder.uuid'>
  </div>
  <div class="form-row node-config-input-initInterval">
    <label for="node-input-initInterval">
      <i class="fa fa-edit"></i>
      <span data-i18n="asakusa_giken.label.initInterval"></span></label>
    <input type="text" id="node-config-input-initInterval" maxlength="5" data-i18n='[placeholder]asakusa_giken.placeholder.initInterval'>
  </div>
  <div class="form-row" id="node-config-input-initDout1">
    <label for='node-config-input-initDout'>
      <i class='fa fa-edit'></i>
      <span data-i18n='asakusa_giken.label.initDout'></span>
    </label>

    <input type="checkbox" id="node-config-input-dout1" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout1" style="width: auto;" data-i18n="asakusa_giken.label.dout1"></label>&nbsp;

    <input type="checkbox" id="node-config-input-dout2" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout2" style="width: auto;" data-i18n="asakusa_giken.label.dout2"></label>&nbsp;

    <input type="checkbox" id="node-config-input-dout3" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout3" style="width: auto;" data-i18n="asakusa_giken.label.dout3"></label>&nbsp;

    <input type="checkbox" id="node-config-input-dout4" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout4" style="width: auto;" data-i18n="asakusa_giken.label.dout4"></label>&nbsp;

  </div>
  <div class="form-row" id="node-config-input-initDout2">
    <label>&nbsp;</label>

    <input type="checkbox" id="node-config-input-dout5" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout5" style="width: auto;" data-i18n="asakusa_giken.label.dout5"></label>&nbsp;

    <input type="checkbox" id="node-config-input-dout6" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout6" style="width: auto;" data-i18n="asakusa_giken.label.dout6"></label>&nbsp;

    <input type="checkbox" id="node-config-input-dout7" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout7" style="width: auto;" data-i18n="asakusa_giken.label.dout7"></label>&nbsp;

    <input type="checkbox" id="node-config-input-dout8" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-dout8" style="width: auto;" data-i18n="asakusa_giken.label.dout8"></label>&nbsp;
  </div>
  <div class="form-row node-config-input-initLcd">
    <label for="node-config-input-initLcd">
      <i class="fa fa-edit"></i>
      <span data-i18n="asakusa_giken.label.initLcd"></span></label>
    <input type="text" id="node-config-input-initLcd" maxlength="16" data-i18n='[placeholder]asakusa_giken.placeholder.initLcd'>
  </div>
  <div class="form-row node-config-input-pwm1">
    <label for="node-config-input-pwm1">
      <i class="fa fa-edit"></i>
      <span data-i18n="asakusa_giken.label.initPwm1"></span></label>
    <input type="text" id="node-config-input-pwm1" maxlength="3" data-i18n='[placeholder]asakusa_giken.placeholder.initPwm'>
  </div>
  <div class="form-row node-config-input-pwm2">
    <label for="node-config-input-pwm2">
      <i class="fa fa-edit"></i>
      <span data-i18n="asakusa_giken.label.initPwm2"></span></label>
    <input type="text" id="node-config-input-pwm2" maxlength="3" data-i18n='[placeholder]asakusa_giken.placeholder.initPwm'>
  </div>
  <div class="form-row node-config-input-pwm3">
    <label for="node-config-input-pwm3">
      <i class="fa fa-edit"></i>
      <span data-i18n="asakusa_giken.label.initPwm3"></span></label>
    <input type="text" id="node-config-input-pwm3" maxlength="3" data-i18n='[placeholder]asakusa_giken.placeholder.initPwm'>
  </div>
</script>

<script type='text/javascript'>
  const LCD_CHAR_TABLE = {
    0x00: '', 0x01: '', 0x02: '', 0x03: '', 0x04: '', 0x05: '', 0x06: '↓', 0x07: '→',
    0x08: '←', 0x09: ['⌈','┌','┍','┎','┏'], 0x0A: ['⌉','┐','┑','┒','┓'],
      0x0B: ['⌊','└','┕','┖','┗'], 0x0C: ['⌋','┘','┙','┚','┛'],
      0x0D: ['•','⋅'], 0x0E: '®', 0x0F: '©',
    0x10: '™', 0x11: '†', 0x12: '§', 0x13: '¶', 0x14: 'Γ', 0x15: '∆', 0x16: 'Θ', 0x17: 'Λ',
    0x18: 'Ξ', 0x19: 'Π', 0x1A: 'Σ', 0x1B: 'Υ', 0x1C: 'Φ', 0x1D: 'Ψ', 0x1E: 'Ω', 0x1F: 'α',
    0x20: ' ', 0x21: '!', 0x22: '"', 0x23: '#', 0x24: '$', 0x25: '%', 0x26: '&', 0x27: '\'',
    0x28: '(', 0x29: ')', 0x2A: '*', 0x2B: '+', 0x2C: ',', 0x2D: '-', 0x2E: '.', 0x2F: '/',
    0x30: '0', 0x31: '1', 0x32: '2', 0x33: '3', 0x34: '4', 0x35: '5', 0x36: '6', 0x37: '7',
    0x38: '8', 0x39: '9', 0x3A: ':', 0x3B: ';', 0x3C: '<', 0x3D: '=', 0x3E: '>', 0x3F: '?',
    0x40: '@', 0x41: 'A', 0x42: 'B', 0x43: 'C', 0x44: 'D', 0x45: 'E', 0x46: 'F', 0x47: 'G',
    0x48: 'H', 0x49: 'I', 0x4A: 'J', 0x4B: 'K', 0x4C: 'L', 0x4D: 'M', 0x4E: 'N', 0x4F: 'O',
    0x50: 'P', 0x51: 'Q', 0x52: 'R', 0x53: 'S', 0x54: 'T', 0x55: 'U', 0x56: 'V', 0x57: 'W',
    0x58: 'X', 0x59: 'Y', 0x5A: 'Z', 0x5B: '[', 0x5C: '\\', 0x5D: ']', 0x5E: '^', 0x5F: '_',
    0x60: '`', 0x61: 'a', 0x62: 'b', 0x63: 'c', 0x64: 'd', 0x65: 'e', 0x66: 'f', 0x67: 'g',
    0x68: 'h', 0x69: 'i', 0x6A: 'j', 0x6B: 'k', 0x6C: 'l', 0x6D: 'm', 0x6E: 'n', 0x6F: 'o',
    0x70: 'p', 0x71: 'q', 0x72: 'r', 0x73: 's', 0x74: 't', 0x75: 'u', 0x76: 'v', 0x77: 'w',
    0x78: 'x', 0x79: 'y', 0x7A: 'z', 0x7B: '{', 0x7C: '|', 0x7D: '}', 0x7E: '→', 0x7F: '←',
    0x80: 'Ç', 0x81: 'ü', 0x82: 'é', 0x83: 'â', 0x84: 'ä', 0x85: 'à', 0x86: 'å', 0x87: 'ç',
    0x88: 'ê', 0x89: 'ë', 0x8A: 'è', 0x8B: 'ï', 0x8C: 'î', 0x8D: 'ì', 0x8E: 'Ä', 0x8F: 'Å',
    0x90: 'É', 0x91: 'æ', 0x92: 'Æ', 0x93: 'ô', 0x94: 'ö', 0x95: 'ò', 0x96: 'û', 0x97: 'ù',
    0x98: 'ÿ', 0x99: 'Ö', 0x9A: 'Ü', 0x9B: 'ñ', 0x9C: 'Ñ', 0x9D: 'ā', 0x9E: 'ō', 0x9F: '¿',
    0xA0: ' ', 0xA1: '｡', 0xA2: '｢', 0xA3: '｣', 0xA4: '､', 0xA5: '･', 0xA6: 'ｦ', 0xA7: 'ｧ',
    0xA8: 'ｨ', 0xA9: 'ｩ', 0xAA: 'ｪ', 0xAB: 'ｫ', 0xAC: 'ｬ', 0xAD: 'ｭ', 0xAE: 'ｮ', 0xAF: 'ｯ',
    0xB0: 'ｰ', 0xB1: 'ｱ', 0xB2: 'ｲ', 0xB3: 'ｳ', 0xB4: 'ｴ', 0xB5: 'ｵ', 0xB6: 'ｶ', 0xB7: 'ｷ',
    0xB8: 'ｸ', 0xB9: 'ｹ', 0xBA: 'ｺ', 0xBB: 'ｻ', 0xBC: 'ｼ', 0xBD: 'ｽ', 0xBE: 'ｾ', 0xBF: 'ｿ',
    0xC0: 'ﾀ', 0xC1: 'ﾁ', 0xC2: 'ﾂ', 0xC3: 'ﾃ', 0xC4: 'ﾄ', 0xC5: 'ﾅ', 0xC6: 'ﾆ', 0xC7: 'ﾇ',
    0xC8: 'ﾈ', 0xC9: 'ﾉ', 0xCA: 'ﾊ', 0xCB: 'ﾋ', 0xCC: 'ﾌ', 0xCD: 'ﾍ', 0xCE: 'ﾎ', 0xCF: 'ﾏ',
    0xD0: 'ﾐ', 0xD1: 'ﾑ', 0xD2: 'ﾒ', 0xD3: 'ﾓ', 0xD4: 'ﾔ', 0xD5: 'ﾕ', 0xD6: 'ﾖ', 0xD7: 'ﾗ',
    0xD8: 'ﾘ', 0xD9: 'ﾙ', 0xDA: 'ﾚ', 0xDB: 'ﾛ', 0xDC: 'ﾜ', 0xDD: 'ﾝ', 0xDE: 'ﾞ', 0xDF: 'ﾟ',
    0xE0: 'á', 0xE1: 'í', 0xE2: 'ó', 0xE3: 'ú', 0xE4: '¢', 0xE5: '£', 0xE6: '¥', 0xE7: '㌽',
    0xE8: 'ƒ', 0xE9: '¡', 0xEA: 'Ã', 0xEB: 'ã', 0xEC: 'Õ', 0xED: 'õ', 0xEE: 'Ø', 0xEF: 'ø',
    0xF0: '˙', 0xF1: '¨', 0xF2: ['˚','°'], 0xF3: 'ˋ', 0xF4: 'ˊ', 0xF5: '½', 0xF6: '¼', 0xF7: '×',
    0xF8: '÷', 0xF9: '≤', 0xFA: '≥', 0xFB: '≪', 0xFC: '≫', 0xFD: '≠', 0xFE: '√', 0xFF: '‾',
  };
  const LCD_CHAR_TABLE_REV = {};
  Object.keys(LCD_CHAR_TABLE).forEach(function(code) {
    var chars = LCD_CHAR_TABLE[code];
    if (Array.isArray(chars)) {
      chars.forEach(function(c) {
        LCD_CHAR_TABLE_REV[c] = code;
      });
    } else {
     LCD_CHAR_TABLE_REV[chars] = code;
    }
  });
  RED.nodes.registerType('BLEIo',{
    category: 'config',
    defaults: {
      localName: { value: '', required: true },
      address: { value: '', required: false },
      uuid: { value: '', required: false },
      initInterval: { value: '500', required: true },
      initDout: { value: '0', required: true },
      initLcd: { value: '', required: false, validate: function(v) {
        if (!v) {
          return true;
        }
        var i;
        for (i = 0; i < v.length; i++) {
          if (!LCD_CHAR_TABLE_REV[v.charAt(i)]) {
            return false;
          }
        }
        return true;
      }},
      initPwm: { value: '0', required: true },
    },
    label: function() {
      return this.localName;
    },
    oneditprepare: function() {
      var localNames = [];
      var i;
      for (i = 0; i < 16; i++) {
        var n = 'BLEIo_' + i.toString(16).toUpperCase();
        localNames.push(n);
      }
      var that = this;
      RED.nodes.eachConfig(function(c) {
        if (c.type === 'BLEIo' && that.id !== c.id &&
            localNames.indexOf(c.localName) >= 0) {
          localNames.splice(localNames.indexOf(c.localName), 1);
        }
      });
      $('#node-config-input-localName').append(option);
      for (i = 0; i < localNames.length; i++) {
        var localName = localNames[i];
        var option = $('<option></option>').attr('value', localName)
          .text(localName);
        $('#node-config-input-localName').append(option);
      }
      $('#node-config-input-address').blur(function() {
        var text = $(this).val();
        if (text && typeof(text) === 'string') {
          $(this).val(text.toLowerCase().replace(new RegExp('-', 'g'), ':').trim());
        }
      });
      $('#node-config-input-uuid').blur(function() {
        var text = $(this).val();
        if (text && typeof(text) === 'string') {
          $(this).val(text.toLowerCase().trim());
        }
      });

      var dout = parseInt(this.initDout) || 0;
      // bit 0 = DOUT1 => bit 7 = DOUT8
      for (i = 1; i <= 8; i++) {
        $('#node-config-input-dout' + i).prop('checked', (dout & 1) === 1);
        dout >>= 1;
      }

      var pwm = parseInt(this.initPwm) || 0;
      // byte 0 = PWM1 => byte 2 = PWM3
      $('#node-config-input-pwm1').val((pwm & 0xFF0000) / 0x10000);
      $('#node-config-input-pwm2').val((pwm & 0x00FF00) / 0x100);
      $('#node-config-input-pwm3').val(pwm & 0x0000FF);
    },
    oneditsave: function() {
      var i;
      if (!this.initInterval) {
        this.initInterval = 500;
      } else if (this.initInterval < 0) {
        this.initInterval = 0; // TURN AIN NOTIFICATION OFF
      } else if (this.initInterval > 60000) {
        this.initInterval = 60000;
      }
      this.initDout = 0;
      for (i = 8; i >= 1; i--) {
        this.initDout += $('#node-config-input-dout' + i).is(':checked') ? 1 : 0;
        this.initDout <<= 1;
      }
      this.initDout >>= 1;
      function truncate(v) {
        v = (parseInt(v) || 0);
        if (v < 0) {
          return 0;
        } else if (v > 100) {
          return 100;
        }
        return v;
      }
      this.initPwm =
        truncate($('#node-config-input-pwm1').val()) * 0x10000 +
        truncate($('#node-config-input-pwm2').val()) * 0x00100 +
        truncate($('#node-config-input-pwm3').val());
    }
  });
</script>


<!-- BLECAST_BL in -->
<script type='text/x-red' data-template-name='BLECAST_BL in'>
  <div class='form-row'>
    <label for='node-input-name'>
      <i class='fa fa-tag'></i>
      <span data-i18n='node-red:common.label.name'></span>
    </label>
    <input type='text' id='node-input-name' data-i18n='[placeholder]node-red:common.label.name'>
  </div>
  <div class="form-row node-input-blecastBl">
    <label for="node-input-blecastBl">
      <i class="fa fa-random"></i>
      <span data-i18n="asakusa_giken.label.blecastBl"></span></label>
    <input type="text" id="node-input-blecastBl">
  </div>
  <div class="form-row" id="node-useString">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-useString" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-useString" style="width: 70%;" data-i18n="asakusa_giken.label.useString"></label>
  </div>
</script>

<script type='text/javascript'>
  RED.nodes.registerType('BLECAST_BL in',{
    category: 'input',
    defaults: {
      name: { name: '' },
      blecastBl: { type: 'BLECAST_BL', required: true },
      useString: { value: false, required: false }
    },
    color: 'SkyBlue',
    inputs: 0,
    outputs: 1,
    icon: "blecast_bl.png",
    label: function() {
      return this.name || 'BLECAST_BL';
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<!-- BLECAST_BL -->
<script type='text/x-red' data-template-name='BLECAST_BL'>
  <div class='form-row'>
    <label for='node-config-input-address'>
      <i class='fa fa-random'></i>
      <span data-i18n='asakusa_giken.label.address'></span>
    </label>
    <input type='text' id='node-config-input-address' data-i18n='[placeholder]asakusa_giken.placeholder.address'>
  </div>
  <div class='form-row'>
    <label for='node-config-input-uuid'>
      <i class='fa fa-random'></i>
      <span data-i18n='asakusa_giken.label.uuid'></span>
    </label>
    <input type='text' id='node-config-input-uuid' data-i18n='[placeholder]asakusa_giken.placeholder.uuid'>
  </div>
</script>

<script type='text/javascript'>
  RED.nodes.registerType('BLECAST_BL',{
    category: 'config',
    defaults: {
      address: { value: '', required: true },
      uuid: { value: '', required: false }
    },
    label: function() {
      return this.address;
    },
    oneditprepare: function() {
      $('#node-config-input-address').blur(function() {
        var text = $(this).val();
        if (text && typeof(text) === 'string') {
          $(this).val(text.toLowerCase().replace(new RegExp('-', 'g'), ':').trim());
        }
      });
      $('#node-config-input-uuid').blur(function() {
        var text = $(this).val();
        if (text && typeof(text) === 'string') {
          $(this).val(text.toLowerCase().trim());
        }
      });
    }
  });
</script>


<!-- BLECAST_TM in -->
<script type='text/x-red' data-template-name='BLECAST_TM in'>
  <div class='form-row'>
    <label for='node-input-name'>
      <i class='fa fa-tag'></i>
      <span data-i18n='node-red:common.label.name'></span>
    </label>
    <input type='text' id='node-input-name' data-i18n='[placeholder]node-red:common.label.name'>
  </div>
  <div class="form-row node-input-blecastTm">
    <label for="node-input-blecastTm">
      <i class="fa fa-random"></i>
      <span data-i18n="asakusa_giken.label.blecastTm"></span></label>
    <input type="text" id="node-input-blecastTm">
  </div>
  <div class="form-row" id="node-useString">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-useString" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-useString" style="width: 70%;" data-i18n="asakusa_giken.label.useString"></label>
  </div>
</script>

<script type='text/javascript'>
  RED.nodes.registerType('BLECAST_TM in',{
    category: 'input',
    defaults: {
      name: { name: '' },
      blecastTm: { type: 'BLECAST_TM', required: true },
      useString: { value: false, required: false }
    },
    color: 'Gold',
    inputs: 0,
    outputs: 1,
    icon: "blecast_tm.png",
    label: function() {
      return this.name || 'BLECAST_TM';
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    }
  });
</script>

<!-- BLECAST_TM -->
<script type='text/x-red' data-template-name='BLECAST_TM'>
  <div class='form-row'>
    <label for='node-config-input-address'>
      <i class='fa fa-random'></i>
      <span data-i18n='asakusa_giken.label.address'></span>
    </label>
    <input type='text' id='node-config-input-address' data-i18n='[placeholder]asakusa_giken.placeholder.address'>
  </div>
  <div class='form-row'>
    <label for='node-config-input-uuid'>
      <i class='fa fa-random'></i>
      <span data-i18n='asakusa_giken.label.uuid'></span>
    </label>
    <input type='text' id='node-config-input-uuid' data-i18n='[placeholder]asakusa_giken.placeholder.uuid'>
  </div>
</script>

<script type='text/javascript'>
  RED.nodes.registerType('BLECAST_TM',{
    category: 'config',
    defaults: {
      address: { value: '', required: true },
      uuid: { value: '', required: false }
    },
    label: function() {
      return this.address;
    },
    oneditprepare: function() {
      $('#node-config-input-address').blur(function() {
        var text = $(this).val();
        if (text && typeof(text) === 'string') {
          $(this).val(text.toLowerCase().replace(new RegExp('-', 'g'), ':').trim());
        }
      });
      $('#node-config-input-uuid').blur(function() {
        var text = $(this).val();
        if (text && typeof(text) === 'string') {
          $(this).val(text.toLowerCase().trim());
        }
      });
    }
  });
</script>
